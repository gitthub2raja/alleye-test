import{r as g,C as r,j as e,B as b,s as L,a as Q}from"./index-D0LKihWx.js";import{D as V}from"./DataTable-DsP_0w7v.js";import{V as U}from"./ViewHeader-DDi3cdYh.js";import{M as z}from"./Modal-BcWOlSgM.js";const B=({isOpen:y,onClose:O,content:x,currentUser:_,allOrganizations:N})=>{var D,I,C;const[a,j]=g.useState({title:"",description:"",type:r.VIDEO,content_url:"",embed_url:"",html_content:"",questions:[],quiz_data:"",tags:[],visibility:"org-wide",duration_sec:0,risk_tags:[],compliance:[],thumbnail_url:"",category:"",difficulty:"Intro",passing_score:70,assigned_org_ids:[],...x}),[p,f]=g.useState({question:"",options:["","","",""],correctAnswer:0}),[A,d]=g.useState(!1),u=s=>{const{name:n,value:l}=s.target,t=n==="duration_sec"||n==="passing_score"?parseInt(l,10):l;j(i=>({...i,[n]:t}))},o=(s,n)=>{j(l=>({...l,[n]:s.target.value.split(",").map(t=>t.trim())}))},S=s=>{const n=Array.from(s.target.selectedOptions,l=>l.value);j(l=>({...l,assigned_org_ids:n.includes("all")?[]:n}))},E=s=>{const{name:n,value:l}=s.target;f(t=>({...t,[n]:l}))},R=(s,n)=>{const l=[...p.options];l[s]=n,f(t=>({...t,options:l}))},k=()=>{if(p.question&&p.options.every(s=>s)){const s={...p,id:Date.now()};j(n=>({...n,questions:[...n.questions||[],s]})),f({question:"",options:["","","",""],correctAnswer:0})}else alert("Please fill out the question and all four options.")},w=s=>{j(n=>{var l;return{...n,questions:(l=n.questions)==null?void 0:l.filter(t=>t.id!==s)}})},v=async s=>{var t;s.preventDefault(),d(!0);const n={...a,creator_id:_.id,quiz_data:a.type===r.CYBER_SECURITY_TRAINING&&(((t=a.questions)==null?void 0:t.length)??0)>0?JSON.stringify(a.questions):a.quiz_data};let l;if(x!=null&&x.id){const{error:i}=await L.from("content").update(n).eq("id",x.id);l=i}else{const{error:i}=await L.from("content").insert(n);l=i}l?alert(`Error saving content: ${l.message}`):O(),d(!1)},T=a.type===r.VIDEO_QUIZ||a.type===r.QUIZ||a.type===r.CYBER_SECURITY_TRAINING;return e.jsx(z,{isOpen:y,onClose:O,title:x?"Edit Content":"Add New Content",size:"2xl",children:e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{children:"Title"}),e.jsx("input",{name:"title",value:a.title,onChange:u,className:"form-input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Content Type"}),e.jsx("select",{name:"type",value:a.type,onChange:u,className:"form-select",required:!0,children:Object.values(r).map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{name:"description",value:a.description,onChange:u,className:"form-input"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{children:"Category"}),e.jsx("input",{name:"category",value:a.category,onChange:u,className:"form-input",placeholder:"e.g., Phishing, Compliance"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Difficulty"}),e.jsxs("select",{name:"difficulty",value:a.difficulty,onChange:u,className:"form-select",children:[e.jsx("option",{value:"Intro",children:"Intro"}),e.jsx("option",{value:"Intermediate",children:"Intermediate"}),e.jsx("option",{value:"Advanced",children:"Advanced"})]})]})]}),a.type===r.HTML&&e.jsxs("div",{children:[e.jsx("label",{children:"HTML Content"}),e.jsx("textarea",{name:"html_content",value:a.html_content,onChange:u,className:"form-input font-mono",rows:10})]}),a.type===r.CYBER_SECURITY_TRAINING&&e.jsxs("div",{children:[e.jsx("label",{children:"Video URL (e.g., Supabase Storage)"}),e.jsx("input",{name:"content_url",value:a.content_url,onChange:u,className:"form-input",placeholder:"https://..."})]}),([r.VIDEO,r.VIDEO_QUIZ].includes(a.type)||[r.PDF,r.SCORM,r.HTML5,r.REACT_SANDBOX].includes(a.type))&&e.jsxs("div",{children:[e.jsx("label",{children:[r.PDF,r.SCORM,r.HTML5,r.REACT_SANDBOX].includes(a.type)?"Embed URL":"Content URL"}),e.jsx("input",{name:[r.PDF,r.SCORM,r.HTML5,r.REACT_SANDBOX].includes(a.type)?"embed_url":"content_url",value:a.embed_url||a.content_url,onChange:u,className:"form-input"})]}),T&&e.jsxs("div",{className:"p-4 border border-border rounded-lg space-y-4",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Quiz Questions"}),e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-2 pr-2",children:(D=a.questions)==null?void 0:D.map((s,n)=>e.jsxs("div",{className:"bg-sidebar-accent p-2 rounded-md",children:[e.jsxs("p",{className:"text-sm font-semibold flex justify-between",children:[e.jsxs("span",{children:[n+1,". ",s.question]}),e.jsx("button",{type:"button",onClick:()=>w(s.id),className:"text-red-500 hover:text-red-400",children:"Ã—"})]}),e.jsx("ul",{className:"text-xs list-disc pl-5",children:s.options.map((l,t)=>e.jsx("li",{className:t===s.correctAnswer?"font-bold text-green-400":"",children:l},t))})]},s.id))}),e.jsxs("div",{className:"space-y-2 pt-4 border-t border-border",children:[e.jsx("h4",{className:"font-semibold",children:"Add New Question"}),e.jsx("textarea",{name:"question",value:p.question,onChange:E,placeholder:"Question text (can be HTML)",className:"form-input"}),p.options.map((s,n)=>e.jsx("input",{value:s,onChange:l=>R(n,l.target.value),placeholder:`Option ${n+1}`,className:"form-input"},n)),e.jsx("select",{name:"correctAnswer",value:p.correctAnswer,onChange:s=>f(n=>({...n,correctAnswer:parseInt(s.target.value)})),className:"form-select",children:p.options.map((s,n)=>e.jsxs("option",{value:n,children:["Option ",n+1," is correct"]},n))}),e.jsx(b,{type:"button",variant:"secondary",onClick:k,children:"Add Question"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{children:"Tags (comma-separated)"}),e.jsx("input",{name:"tags",value:(I=a.tags)==null?void 0:I.join(", "),onChange:s=>o(s,"tags"),className:"form-input"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Thumbnail URL"}),e.jsx("input",{name:"thumbnail_url",value:a.thumbnail_url,onChange:u,className:"form-input"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Duration (seconds)"}),e.jsx("input",{type:"number",name:"duration_sec",value:a.duration_sec,onChange:u,className:"form-input"})]}),T&&e.jsxs("div",{children:[e.jsx("label",{children:"Passing Score (%)"}),e.jsx("input",{type:"number",name:"passing_score",value:a.passing_score,onChange:u,className:"form-input"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Assign to Organizations"}),e.jsxs("select",{multiple:!0,name:"assigned_org_ids",value:((C=a.assigned_org_ids)==null?void 0:C.length)===0?["all"]:a.assigned_org_ids,onChange:S,className:"form-select h-32",children:[e.jsx("option",{value:"all",children:"All Organizations"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("p",{className:"text-xs text-text-secondary mt-1",children:"Hold Ctrl/Cmd to select multiple. Selecting 'All Organizations' will override other selections."})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(b,{type:"submit",disabled:A,children:A?"Saving...":"Save Content"})})]})})},Z=({content:y,setContent:O,currentUser:x,allOrganizations:_})=>{const[N,a]=g.useState(!1),[j,p]=g.useState(null),[f,A]=g.useState(""),[d,u]=g.useState({category:"All",difficulty:"All",type:"All"}),[o,S]=g.useState({key:"created_at",direction:"descending"}),E=g.useMemo(()=>["All",...Array.from(new Set(y.map(t=>t.category).filter(Boolean)))],[y]),R=["All","Intro","Intermediate","Advanced"],k=["All",...Object.values(r)],w={Intro:1,Intermediate:2,Advanced:3},v=t=>{const{name:i,value:m}=t.target;i==="searchTerm"?A(m):u(c=>({...c,[i]:m}))},T=t=>{let i="ascending";o&&o.key===t&&o.direction==="ascending"&&(i="descending"),S({key:t,direction:i})},D=t=>{const[i,m]=t.target.value.split("-");S({key:i,direction:m})},I=g.useMemo(()=>{let t=[...y];if(d.category!=="All"&&(t=t.filter(i=>i.category===d.category)),d.difficulty!=="All"&&(t=t.filter(i=>i.difficulty===d.difficulty)),d.type!=="All"&&(t=t.filter(i=>i.type===d.type)),f){const i=f.toLowerCase();t=t.filter(m=>m.title.toLowerCase().includes(i)||m.description.toLowerCase().includes(i))}return o&&t.sort((i,m)=>{if(o.key==="difficulty"){const q=w[i.difficulty],M=w[m.difficulty];return q===void 0?1:M===void 0?-1:o.direction==="ascending"?q-M:M-q}const c=i[o.key],h=m[o.key];return c==null?1:h==null?-1:typeof c=="number"&&typeof h=="number"?o.direction==="ascending"?c-h:h-c:typeof c=="string"&&typeof h=="string"?o.direction==="ascending"?c.localeCompare(h):h.localeCompare(c):0}),t},[y,d,f,o]),C=(t=null)=>{p(t),a(!0)},s=()=>{p(null),a(!1)},n=async t=>{if(window.confirm("Are you sure you want to delete this content? This action cannot be undone.")){const{error:i}=await L.from("content").delete().eq("id",t);i&&alert(`Error: ${i.message}`)}},l=[{key:"title",header:"Title",sortable:!0},{key:"type",header:"Type",sortable:!0},{key:"category",header:"Category",sortable:!0},{key:"difficulty",header:"Difficulty",sortable:!0},{key:"created_at",header:"Date Added",sortable:!0,render:t=>new Date(t.created_at).toLocaleDateString()},{key:"duration_sec",header:"Duration (sec)",sortable:!0},{key:"assigned_org_ids",header:"Assigned Orgs",render:t=>{var i;return e.jsx("div",{className:"flex flex-wrap gap-1",children:((i=t.assigned_org_ids)==null?void 0:i.map(m=>{const c=_.find(h=>h.id===m);return e.jsx("span",{className:"bg-sidebar-accent px-2 py-0.5 text-xs rounded-full",children:(c==null?void 0:c.name)||"Unknown Org"},m)}))||e.jsx("span",{className:"text-xs text-text-secondary",children:"All"})})}}];return e.jsxs("div",{className:"animate-fade-in",children:[e.jsx(U,{title:"Content Management",subtitle:"Create, edit, and manage all learning materials.",children:e.jsx(b,{onClick:()=>C(),children:"Add New Content"})}),e.jsx(Q,{className:"mb-6 !p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsx("input",{name:"searchTerm",value:f,onChange:v,className:"form-input",placeholder:"Search title or description..."}),e.jsx("select",{name:"category",value:d.category,onChange:v,className:"form-select",children:E.map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsx("select",{name:"difficulty",value:d.difficulty,onChange:v,className:"form-select",children:R.map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsx("select",{name:"type",value:d.type,onChange:v,className:"form-select",children:k.map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsxs("select",{name:"sortBy",value:o?`${o.key}-${o.direction}`:"created_at-descending",onChange:D,className:"form-select",children:[e.jsx("option",{value:"created_at-descending",children:"Recently Added"}),e.jsx("option",{value:"created_at-ascending",children:"Oldest First"}),e.jsx("option",{value:"title-ascending",children:"Title (A-Z)"}),e.jsx("option",{value:"title-descending",children:"Title (Z-A)"}),e.jsx("option",{value:"difficulty-ascending",children:"Difficulty (Easy to Hard)"}),e.jsx("option",{value:"difficulty-descending",children:"Difficulty (Hard to Easy)"})]})]})}),e.jsx(V,{columns:l,data:I,sortConfig:o,onSort:T,renderActions:t=>e.jsxs("div",{className:"space-x-2",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>C(t),children:"Edit"}),e.jsx(b,{variant:"danger",size:"sm",onClick:()=>n(t.id),children:"Delete"})]})}),N&&e.jsx(B,{isOpen:N,onClose:s,content:j,currentUser:x,allOrganizations:_})]})};export{Z as default};
