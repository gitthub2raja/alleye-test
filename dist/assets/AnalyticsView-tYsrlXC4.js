import{r as i,j as e,B as E,a as b}from"./index-D0LKihWx.js";import{V as z}from"./ViewHeader-DDi3cdYh.js";import{f as _}from"./xapiLrsClient-D85D4vVW.js";import{R as P,T as $}from"./CartesianChart-XZ9oN6o3.js";import{L as X,a as B}from"./LineChart-DOCE-dDr.js";import{C as T,L as O}from"./CartesianGrid-2KsaLRsv.js";import{X as M}from"./XAxis-cwaU9eXC.js";import{Y as V}from"./YAxis-Bsetyn0C.js";import{P as H,a as G}from"./PieChart-o5d90sGq.js";import{C as Y}from"./tooltipContext-Dsaq1-x6.js";import{B as Q}from"./BarChart-Dr8KpdKm.js";import{B as q}from"./barSelectors-6VLD7Q4g.js";import{D as J}from"./DataTable-DsP_0w7v.js";import"./ActivePoints-C5OEKP8z.js";import"./ErrorBarContext-Dcs2wgOg.js";import"./getRadiusAndStrokeWidthFromDot-DGHXVsRS.js";import"./PolarChart-C5R0AQBq.js";const W=({users:x,content:d})=>{const p=i.useRef(null),[l,m]=i.useState([]),[j,h]=i.useState(!0),[g,y]=i.useState("30"),[w,n]=i.useState("all"),[c,v]=i.useState("all");i.useEffect(()=>{(async()=>{h(!0);const a=new Date;a.setDate(a.getDate()-parseInt(g));const s={since:a.toISOString()};if(w!=="all"){const o=x.find(f=>f.id===w);o&&(s.agent=o)}if(c!=="all"){const o=d.find(f=>f.id===parseInt(c));o&&(s.activity=o)}const r=await _(s);m(r),h(!1)})()},[g,w,c,x,d]);const S=i.useMemo(()=>{const t=new Set(l.map(r=>r.actor.mbox)).size,a=l.filter(r=>{var o,f;return((f=(o=r.result)==null?void 0:o.score)==null?void 0:f.raw)!==void 0}).map(r=>r.result.score.raw),s=a.length>0?a.reduce((r,o)=>r+o,0)/a.length:0;return{totalStatements:l.length,activeLearners:t,averageScore:s}},[l]),u=i.useMemo(()=>{const t={};return l.forEach(a=>{const s=new Date(a.timestamp).toLocaleDateString("en-US",{month:"short",day:"numeric"});t[s]||(t[s]={date:s,Launched:0,Completed:0}),a.verb.id.includes("launched")&&t[s].Launched++,a.verb.id.includes("completed")&&t[s].Completed++}),Object.values(t).sort((a,s)=>new Date(a.date).getTime()-new Date(s.date).getTime())},[l]),A=i.useMemo(()=>{const t={desktop:0,mobile:0,unknown:0};return l.forEach(a=>{var r,o;const s=((o=(r=a.context)==null?void 0:r.extensions)==null?void 0:o["https://w3id.org/xapi/acrossx/extensions/device-type"])||"unknown";t[s]!==void 0?t[s]++:t.unknown++}),Object.entries(t).map(([a,s])=>({name:a,value:s}))},[l]),k=i.useMemo(()=>{const t=[{name:"0-20",count:0},{name:"21-40",count:0},{name:"41-60",count:0},{name:"61-80",count:0},{name:"81-100",count:0}];return l.forEach(a=>{var s,r;if(((r=(s=a.result)==null?void 0:s.score)==null?void 0:r.raw)!==void 0){const o=a.result.score.raw;o<=20?t[0].count++:o<=40?t[1].count++:o<=60?t[2].count++:o<=80?t[3].count++:t[4].count++}}),t},[l]),C=i.useMemo(()=>{const t={};l.forEach(s=>{var o;const r=(o=s.object)==null?void 0:o.id;r&&(t[r]||(t[r]={launches:0,completions:0}),s.verb.id.includes("launched")&&t[r].launches++,s.verb.id.includes("completed")&&t[r].completions++)});const a=Object.entries(t).map(([s,r])=>{const o=d.find(f=>`https://lms.example.com/content/${f.id}`===s);return{title:(o==null?void 0:o.title)||"Unknown Content",rate:r.launches>0?r.completions/r.launches*100:0}});return{mostCompleted:[...a].sort((s,r)=>r.rate-s.rate).slice(0,6),leastCompleted:[...a].filter(s=>s.rate<100).sort((s,r)=>s.rate-r.rate).slice(0,6)}},[l,d]),L=()=>{var o,f,R,F,U;if(l.length===0)return alert("No data to export.");const a=[["Timestamp","Actor Name","Actor Email","Verb","Activity Name","Success","Score"].join(",")];for(const N of l){const K=[`"${new Date(N.timestamp).toLocaleString()}"`,`"${N.actor.name||""}"`,`"${N.actor.mbox||""}"`,`"${N.verb.display["en-US"]||N.verb.id}"`,`"${((f=(o=N.object.definition)==null?void 0:o.name)==null?void 0:f["en-US"])||""}"`,`"${((R=N.result)==null?void 0:R.success)??"N/A"}"`,`"${((U=(F=N.result)==null?void 0:F.score)==null?void 0:U.raw)??"N/A"}"`];a.push(K.join(","))}const s=new Blob([a.join(`
`)],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download="xapi_analytics.csv",r.click()},I=()=>{const t=p.current;if(!t||!window.html2canvas||!window.jspdf){alert("PDF generation library not available.");return}window.html2canvas(t,{useCORS:!0,backgroundColor:"#151515"}).then(a=>{const s=a.toDataURL("image/png"),r=new window.jspdf.jsPDF({orientation:"landscape",unit:"px",format:[a.width,a.height]});r.addImage(s,"PNG",0,0,a.width,a.height),r.save("xapi_dashboard.pdf")})},D=["#8884d8","#ffc658","#82ca9d"];return j?e.jsx("div",{children:"Loading dashboard..."}):e.jsxs("div",{ref:p,className:"space-y-6 bg-background p-1",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-text-main",children:"xAPI Analytics Dashboard"}),e.jsx("p",{className:"text-text-secondary text-sm",children:"Deep dive into learner behavior across all platforms."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:g,onChange:t=>y(t.target.value),className:"form-select text-sm",children:[e.jsx("option",{value:"30",children:"Last 30 Days"}),e.jsx("option",{value:"7",children:"Last 7 Days"}),e.jsx("option",{value:"90",children:"Last 90 Days"})]}),e.jsxs("select",{value:w,onChange:t=>n(t.target.value),className:"form-select text-sm",children:[e.jsx("option",{value:"all",children:"All Users"}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:c,onChange:t=>v(t.target.value),className:"form-select text-sm",children:[e.jsx("option",{value:"all",children:"All Content"}),d.map(t=>e.jsx("option",{value:String(t.id),children:t.title},t.id))]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(E,{onClick:I,children:"Export PDF"}),e.jsx(E,{onClick:L,children:"Export CSV"}),e.jsx(E,{variant:"ghost",onClick:()=>alert("Email sharing not implemented."),children:"Share to Email"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(b,{className:"text-center",children:[e.jsx("p",{className:"text-text-secondary",children:"Total Statements"}),e.jsx("p",{className:"text-4xl font-bold text-text-main",children:S.totalStatements})]}),e.jsxs(b,{className:"text-center",children:[e.jsx("p",{className:"text-text-secondary",children:"Active Learners"}),e.jsx("p",{className:"text-4xl font-bold text-text-main",children:S.activeLearners})]}),e.jsxs(b,{className:"text-center",children:[e.jsx("p",{className:"text-text-secondary",children:"Average Score"}),e.jsxs("p",{className:"text-4xl font-bold text-text-main",children:[S.averageScore.toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-6",children:[e.jsxs(b,{className:"lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Engagement Over Time"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(X,{data:u,children:[e.jsx(T,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),e.jsx(M,{dataKey:"date",tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx(V,{tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx($,{contentStyle:{backgroundColor:"var(--card-color)",border:"1px solid var(--border-color)"}}),e.jsx(O,{}),e.jsx(B,{type:"monotone",dataKey:"Launched",stroke:"#8884d8"}),e.jsx(B,{type:"monotone",dataKey:"Completed",stroke:"#82ca9d"})]})})]}),e.jsxs(b,{className:"lg:col-span-2",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Device Usage"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(H,{children:[e.jsx(G,{data:A,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:A.map((t,a)=>e.jsx(Y,{fill:D[a%D.length]},`cell-${a}`))}),e.jsx($,{contentStyle:{backgroundColor:"var(--card-color)",border:"1px solid var(--border-color)"}}),e.jsx(O,{})]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(b,{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Quiz Score Distribution"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(Q,{data:k,children:[e.jsx(T,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),e.jsx(M,{dataKey:"name",tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx(V,{tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx($,{contentStyle:{backgroundColor:"var(--card-color)",border:"1px solid var(--border-color)"}}),e.jsx(q,{dataKey:"count",fill:"#8884d8",name:"Learners"})]})})]}),e.jsxs(b,{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Content Hotspots"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-green-400",children:"Most Completed"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc list-inside",children:C.mostCompleted.map(t=>e.jsxs("li",{children:[" ",t.title," ",e.jsxs("span",{className:"text-text-secondary",children:["(",t.rate.toFixed(0),"%)"]})," "]},t.title))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-red-400",children:"Least Completed"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc list-inside",children:C.leastCompleted.map(t=>e.jsxs("li",{children:[" ",t.title," ",e.jsxs("span",{className:"text-text-secondary",children:["(",t.rate.toFixed(0),"%)"]})," "]},t.title))})]})]})]})]})]})},Z=({allUsers:x,allContent:d})=>{const[p,l]=i.useState([]),[m,j]=i.useState(!1),[h,g]=i.useState({userId:"all",contentId:"all"});i.useEffect(()=>{(async()=>{j(!0);let c,v;h.userId!=="all"&&(c=x.find(u=>u.id===h.userId)),h.contentId!=="all"&&(v=d.find(u=>u.id===parseInt(h.contentId)));const S=await _({agent:c,activity:v});l(S),j(!1)})()},[h,x,d]);const y=()=>{var k,C,L,I,D,t,a;if(p.length===0){alert("No data to export.");return}const c=[["Timestamp","Actor Name","Actor Email","Verb","Activity Name","Activity ID","Success","Score","Response","Duration"].join(",")];for(const s of p){const r=[`"${new Date(s.timestamp).toLocaleString()}"`,`"${s.actor.name||""}"`,`"${s.actor.mbox||""}"`,`"${s.verb.display["en-US"]||s.verb.id}"`,`"${((C=(k=s.object.definition)==null?void 0:k.name)==null?void 0:C["en-US"])||""}"`,`"${s.object.id}"`,`"${((L=s.result)==null?void 0:L.success)??"N/A"}"`,`"${((D=(I=s.result)==null?void 0:I.score)==null?void 0:D.raw)??"N/A"}"`,`"${((t=s.result)==null?void 0:t.response)??""}"`,`"${((a=s.result)==null?void 0:a.duration)??"N/A"}"`];c.push(r.join(","))}const v=c.join(`
`),S=new Blob([v],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a"),A=URL.createObjectURL(S);u.setAttribute("href",A),u.setAttribute("download","xapi_report.csv"),document.body.appendChild(u),u.click(),document.body.removeChild(u)},w=[{key:"actor",header:"User",render:n=>n.actor.name||n.actor.mbox},{key:"verb",header:"Action",render:n=>n.verb.display["en-US"]},{key:"object",header:"Object",render:n=>{var c,v;return((v=(c=n.object.definition)==null?void 0:c.name)==null?void 0:v["en-US"])||n.object.id}},{key:"timestamp",header:"Timestamp",render:n=>new Date(n.timestamp).toLocaleString()}];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("select",{value:h.userId,onChange:n=>g(c=>({...c,userId:n.target.value})),className:"form-select",children:[e.jsx("option",{value:"all",children:"All Users"}),x.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]}),e.jsxs("select",{value:h.contentId,onChange:n=>g(c=>({...c,contentId:n.target.value})),className:"form-select",children:[e.jsx("option",{value:"all",children:"All Content"}),d.map(n=>e.jsx("option",{value:String(n.id),children:n.title},n.id))]})]}),e.jsx(E,{onClick:y,children:"Export CSV"})]}),m?e.jsx("p",{children:"Loading LRS data..."}):e.jsx(J,{columns:w,data:p.map(n=>({...n,id:n.id||Math.random().toString()}))})]})},ee=({organizations:x})=>{const[d,p]=i.useState(""),l=i.useMemo(()=>x.find(m=>m.id===d),[x,d]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"org-select",className:"block text-sm font-medium text-text-secondary mb-1",children:"Select an Organization to View Report"}),e.jsxs("select",{id:"org-select",value:d,onChange:m=>p(m.target.value),className:"form-select",children:[e.jsx("option",{value:"",children:"-- Select Organization --"}),x.map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))]})]}),l!=null&&l.powerbi_embed_url?e.jsx(b,{className:"!p-0 overflow-hidden",style:{height:"calc(100vh - 20rem)"},children:e.jsx("iframe",{title:l.name,width:"100%",height:"100%",src:l.powerbi_embed_url,frameBorder:"0",allowFullScreen:!0})}):d?e.jsx(b,{children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Dashboard Not Available"}),e.jsxs("p",{className:"text-text-secondary mt-2",children:["A Power BI dashboard has not been configured for ",l==null?void 0:l.name,"."]})]})}):null]})},ve=({analytics:x,cyberAnalytics:d,content:p,organizations:l,users:m})=>{const[j,h]=i.useState("xAPI Dashboard"),g=["xAPI Dashboard","xAPI Feed","Power BI"];return e.jsxs("div",{className:"animate-fade-in space-y-8",children:[e.jsx(z,{title:"Analytics",subtitle:"Deep dive into platform, learning, and business intelligence data."}),e.jsx("div",{className:"flex border-b border-border",children:g.map(y=>e.jsx("button",{onClick:()=>h(y),className:`px-4 py-2 text-sm font-medium ${j===y?"border-b-2 border-primary text-primary":"text-text-secondary hover:text-text-main"}`,children:y},y))}),e.jsxs("div",{className:"mt-6",children:[j==="xAPI Dashboard"&&e.jsx(W,{users:m,content:p}),j==="xAPI Feed"&&e.jsx(Z,{allUsers:m,allContent:p}),j==="Power BI"&&e.jsx(ee,{organizations:l})]})]})};export{ve as default};
