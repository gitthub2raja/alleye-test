import{r as h,j as t,B as _,s as $,C as L,a as z}from"./index-B1M48IIc.js";import{V as F}from"./ViewHeader-BXgFCfK9.js";import{D as M}from"./DataTable-DFi--VBt.js";import{M as V}from"./Modal-C23alaOS.js";const q=({isOpen:y,onClose:x,item:l,users:v,teams:S,assignments:b})=>{const[p,f]=h.useState(new Set);h.useEffect(()=>{y&&f(new Set(b.map(r=>r.user_id)))},[y,b]);const w=r=>{f(o=>{const c=new Set(o);return c.has(r)?c.delete(r):c.add(r),c})},i=r=>{const o=v.filter(s=>s.team===r).map(s=>s.id),c=o.length>0&&o.every(s=>p.has(s));f(s=>{const j=new Set(s);return c?o.forEach(a=>j.delete(a)):o.forEach(a=>j.add(a)),j})},C=async r=>{r.preventDefault();const o="contentIds"in l,c=l.id,s=o?"playlist_id":"content_id",j=p,a=new Set(b.map(m=>m.user_id)),T=[...j].filter(m=>!a.has(m)),I=[...a].filter(m=>!j.has(m)),k=[];if(T.length>0){const m=T.map(U=>({user_id:U,[s]:c}));k.push($.from("user_assignments").insert(m))}if(I.length>0&&k.push($.from("user_assignments").delete().eq(s,c).in("user_id",I)),k.length===0){x();return}const A=(await Promise.all(k)).map(m=>m.error).filter(Boolean);A.length>0?alert(`An error occurred: ${A.map(m=>m.message).join(", ")}`):(alert("Assignments updated successfully!"),x())},N="contentIds"in l;return t.jsx(V,{isOpen:y,onClose:x,title:`Manage Assignments for: ${N?l.name:l.title}`,children:t.jsxs("form",{onSubmit:C,children:[t.jsx("h3",{className:"font-semibold mb-2",children:"Assign to Teams"}),t.jsx("div",{className:"max-h-40 overflow-y-auto border border-border p-2 rounded-md mb-4",children:S.map(r=>{const o=v.filter(s=>s.team===r.id).map(s=>s.id),c=o.length>0&&o.every(s=>p.has(s));return t.jsxs("label",{className:"flex items-center p-2 rounded-md hover:bg-sidebar-accent cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:c,onChange:()=>i(r.id),className:"h-4 w-4 rounded"}),t.jsx("span",{className:"ml-3 text-text-secondary",children:r.name})]},r.id)})}),t.jsx("h3",{className:"font-semibold mb-2",children:"Assign to Individual Users"}),t.jsx("div",{className:"max-h-60 overflow-y-auto border border-border p-2 rounded-md",children:v.map(r=>t.jsxs("label",{className:"flex items-center p-2 rounded-md hover:bg-sidebar-accent cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:p.has(r.id),onChange:()=>w(r.id),className:"h-4 w-4 rounded"}),t.jsx("span",{className:"ml-3 text-text-secondary",children:r.name})]},r.id))}),t.jsx("div",{className:"flex justify-end pt-4 mt-4 border-t border-border",children:t.jsx(_,{type:"submit",children:"Update Assignments"})})]})})},H=({value:y})=>t.jsx("div",{className:"w-full bg-sidebar-accent rounded-full h-2.5",children:t.jsx("div",{className:"bg-primary h-2.5 rounded-full",style:{width:`${y}%`}})}),O=({isOpen:y,onClose:x,playlist:l,users:v,userAssignments:S})=>{if(!l)return null;const b=h.useMemo(()=>{const f=new Set(S.filter(i=>i.playlist_id===l.id).map(i=>i.user_id));return v.filter(i=>f.has(i.id)).map(i=>{const C=l.contentIds.filter(r=>{var o,c;return((c=(o=i.progress)==null?void 0:o[r])==null?void 0:c.status)==="completed"}).length,N=l.contentIds.length>0?Math.round(C/l.contentIds.length*100):0;return{id:i.id,name:i.name,progress:N}})},[l,v,S]),p=[{key:"name",header:"User"},{key:"progress",header:"Completion Progress",render:f=>t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx(H,{value:f.progress}),t.jsxs("span",{className:"text-sm font-semibold w-12 text-right",children:[f.progress,"%"]})]})}];return t.jsx(V,{isOpen:y,onClose:x,title:`Activity for "${l.name}"`,size:"lg",children:t.jsx(M,{columns:p,data:b})})},Q=({users:y,content:x,playlists:l,currentUser:v,teams:S,userAssignments:b,initialView:p="content"})=>{const[f,w]=h.useState(p),[i,C]=h.useState(null),[N,r]=h.useState(null),[o,c]=h.useState(""),[s,j]=h.useState({category:"All",difficulty:"All",type:"All"}),[a,T]=h.useState({key:"title",direction:"ascending"});h.useEffect(()=>{w(p),T({key:p==="content"?"title":"name",direction:"ascending"})},[p]);const I=h.useMemo(()=>["All",...Array.from(new Set(x.map(e=>e.category).filter(Boolean)))],[x]),k=["All","Intro","Intermediate","Advanced"],P=["All",...Object.values(L)],A=e=>{const{name:n,value:d}=e.target;n==="searchTerm"?c(d):j(u=>({...u,[n]:d}))},m=e=>{let n="ascending";a&&a.key===e&&a.direction==="ascending"&&(n="descending"),T({key:e,direction:n})},U=h.useMemo(()=>{let e=[...x];if(s.category!=="All"&&(e=e.filter(n=>n.category===s.category)),s.difficulty!=="All"&&(e=e.filter(n=>n.difficulty===s.difficulty)),s.type!=="All"&&(e=e.filter(n=>n.type===s.type)),o){const n=o.toLowerCase();e=e.filter(d=>d.title.toLowerCase().includes(n))}return a&&e.sort((n,d)=>{const u=n[a.key],g=d[a.key];return u==null?1:g==null?-1:typeof u=="number"&&typeof g=="number"?a.direction==="ascending"?u-g:g-u:typeof u=="string"&&typeof g=="string"?a.direction==="ascending"?u.localeCompare(g):g.localeCompare(u):0}),e},[x,s,o,a]),D=h.useMemo(()=>{let e=[...l];if(o){const n=o.toLowerCase();e=e.filter(d=>d.name.toLowerCase().includes(n)||d.description.toLowerCase().includes(n))}return a&&e.sort((n,d)=>{const u=n[a.key],g=d[a.key];return typeof u=="string"&&typeof g=="string"?a.direction==="ascending"?u.localeCompare(g):g.localeCompare(u):0}),e},[l,o,a]),E=[{key:"title",header:"Title",sortable:!0},{key:"type",header:"Type",sortable:!0},{key:"passing_score",header:"Passing Score",sortable:!0,render:e=>e.passing_score?`${e.passing_score}%`:"N/A"},{key:"category",header:"Category",sortable:!0},{key:"difficulty",header:"Difficulty",sortable:!0},{key:"assignedCount",header:"Assigned To",render:e=>{const n=b.filter(d=>d.content_id===e.id).length;return`${n} user${n===1?"":"s"}`}}],B=[{key:"name",header:"Playlist Name",sortable:!0},{key:"description",header:"Description",sortable:!0},{key:"assignedCount",header:"Assigned To",render:e=>{const n=b.filter(d=>d.playlist_id===e.id).length;return`${n} user${n===1?"":"s"}`}}];return t.jsxs("div",{className:"animate-fade-in",children:[t.jsx(F,{title:"Assign Training",subtitle:"Assign content or playlists to your teams and users."}),t.jsxs(z,{className:"mb-6 !p-4",children:[t.jsxs("div",{className:"flex border-b border-border mb-4",children:[t.jsx("button",{onClick:()=>w("content"),className:`px-4 py-2 text-sm font-medium ${f==="content"?"border-b-2 border-primary text-primary":"text-text-secondary hover:text-text-main"}`,children:"Content"}),t.jsx("button",{onClick:()=>w("playlists"),className:`px-4 py-2 text-sm font-medium ${f==="playlists"?"border-b-2 border-primary text-primary":"text-text-secondary hover:text-text-main"}`,children:"Playlists"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[t.jsx("input",{name:"searchTerm",value:o,onChange:A,className:"form-input",placeholder:"Search..."}),f==="content"&&t.jsxs(t.Fragment,{children:[t.jsx("select",{name:"category",value:s.category,onChange:A,className:"form-select",children:I.map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsx("select",{name:"difficulty",value:s.difficulty,onChange:A,className:"form-select",children:k.map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsx("select",{name:"type",value:s.type,onChange:A,className:"form-select",children:P.map(e=>t.jsx("option",{value:e,children:e},e))})]})]})]}),f==="content"?t.jsx(M,{columns:E,data:U,sortConfig:a,onSort:m,renderActions:e=>t.jsx(_,{variant:"secondary",size:"sm",onClick:()=>C(e),children:"Manage"})}):t.jsx(M,{columns:B,data:D,sortConfig:a,onSort:m,renderActions:e=>t.jsxs("div",{className:"space-x-2",children:[t.jsx(_,{variant:"ghost",size:"sm",onClick:()=>r(e),children:"View Activity"}),t.jsx(_,{variant:"secondary",size:"sm",onClick:()=>C(e),children:"Manage"})]})}),i&&t.jsx(q,{isOpen:!!i,onClose:()=>C(null),item:i,users:y,teams:S,assignments:b.filter(e=>"contentIds"in i?e.playlist_id===i.id:e.content_id===i.id)}),t.jsx(O,{isOpen:!!N,onClose:()=>r(null),playlist:N,users:y,userAssignments:b})]})};export{Q as default};
