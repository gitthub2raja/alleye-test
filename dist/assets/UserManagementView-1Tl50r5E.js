import{r as g,R as y,j as e,B as x,s as j,a as O}from"./index-B1M48IIc.js";import{V as D}from"./ViewHeader-0is57CUg.js";import{D as R}from"./DataTable-DFi--VBt.js";import{M as I}from"./Modal-C23alaOS.js";const $=({isOpen:u,onClose:w,user:n,organizations:z})=>{const[i,s]=g.useState({name:(n==null?void 0:n.name)||"",email:(n==null?void 0:n.email)||"",password:"",role:(n==null?void 0:n.role)||y.USER,organization_id:(n==null?void 0:n.organization_id)||"",team:(n==null?void 0:n.team)||""}),N=async t=>{if(t.preventDefault(),n){const{error:o}=await j.from("profiles").update({name:i.name,role:i.role,organization_id:i.organization_id||null,team:i.team}).eq("id",n.id);if(o){alert(`Error: ${o.message}`);return}if(i.password){const{error:c}=await j.auth.admin.updateUserById(n.id,{password:i.password});if(c){alert(`Error updating password: ${c.message}`);return}}}else{const{data:o,error:c}=await j.auth.signUp({email:i.email,password:i.password,options:{data:{name:i.name,role:i.role,organization_id:i.organization_id||null,team:i.team,points:0,badges:[],progress:{},avatar_url:`https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(i.name)}`}}});if(c){alert(`Error creating user: ${c.message}`);return}}w()};return e.jsx(I,{isOpen:u,onClose:w,title:n?"Edit User":"Create User",children:e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsx("input",{value:i.name,onChange:t=>s(o=>({...o,name:t.target.value})),placeholder:"Full Name",className:"form-input",required:!0}),e.jsx("input",{type:"email",value:i.email,onChange:t=>s(o=>({...o,email:t.target.value})),placeholder:"Email",className:"form-input",required:!0,disabled:!!n}),e.jsx("input",{type:"password",value:i.password,onChange:t=>s(o=>({...o,password:t.target.value})),placeholder:n?"New Password (optional)":"Password",className:"form-input",required:!n}),e.jsx("select",{value:i.role,onChange:t=>s(o=>({...o,role:t.target.value})),className:"form-select",children:Object.values(y).map(t=>e.jsx("option",{value:t,children:t},t))}),e.jsxs("select",{value:i.organization_id,onChange:t=>s(o=>({...o,organization_id:t.target.value})),className:"form-select",children:[e.jsx("option",{value:"",children:"No Organization"}),z.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("input",{value:i.team,onChange:t=>s(o=>({...o,team:t.target.value})),placeholder:"Team Name",className:"form-input"}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(x,{type:"submit",children:"Save User"})})]})})},q=({users:u,setUsers:w,organizations:n,currentUser:z})=>{const[i,s]=g.useState(!1),[N,t]=g.useState(null),[o,c]=g.useState(""),[d,C]=g.useState({role:"All",organizationId:"All"}),[h,U]=g.useState({key:"created_at",direction:"descending"}),S=g.useMemo(()=>{let a=[...u];o&&(a=a.filter(r=>r.name.toLowerCase().includes(o.toLowerCase()))),d.role!=="All"&&(a=a.filter(r=>r.role===d.role)),d.organizationId!=="All"&&(d.organizationId==="none"?a=a.filter(r=>!r.organization_id):a=a.filter(r=>r.organization_id===d.organizationId));const l=new Map(n.map(r=>[r.id,r.name]));return a.sort((r,A)=>{const{key:f,direction:k}=h;let m,p;if(f==="organization"?(m=l.get(r.organization_id||"")||"",p=l.get(A.organization_id||"")||""):(m=r[f],p=A[f]),m==null)return 1;if(p==null)return-1;let v=0;return typeof m=="string"&&typeof p=="string"&&(f==="created_at"?v=new Date(m).getTime()-new Date(p).getTime():v=m.localeCompare(p)),k==="ascending"?v:-v}),a},[u,o,d,h,n]),_=(a=null)=>{t(a),s(!0)},b=()=>{t(null),s(!1)},E=async a=>{if(a===z.id){alert("You cannot delete your own account.");return}if(window.confirm("Are you sure you want to delete this user?")){const{error:l}=await j.auth.admin.deleteUser(a);l&&alert(`Error: ${l.message}`)}},M=[{key:"name",header:"Name"},{key:"email",header:"Email"},{key:"role",header:"Role"},{key:"organization_id",header:"Organization",render:a=>{var l;return((l=n.find(r=>r.id===a.organization_id))==null?void 0:l.name)||e.jsx("span",{className:"text-text-secondary italic",children:"None"})}},{key:"created_at",header:"Date Added",render:a=>a.created_at?new Date(a.created_at).toLocaleString():"N/A"}];return e.jsxs("div",{className:"animate-fade-in",children:[e.jsx(D,{title:"Global User Management",subtitle:"Manage all users across all organizations.",children:e.jsx(x,{onClick:()=>_(),children:"Create User"})}),e.jsx(O,{className:"mb-6 !p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx("input",{value:o,onChange:a=>c(a.target.value),className:"form-input",placeholder:"Search by name..."}),e.jsxs("select",{value:d.role,onChange:a=>C(l=>({...l,role:a.target.value})),className:"form-select",children:[e.jsx("option",{value:"All",children:"All Roles"}),Object.values(y).map(a=>e.jsx("option",{value:a,children:a},a))]}),e.jsxs("select",{value:d.organizationId,onChange:a=>C(l=>({...l,organizationId:a.target.value})),className:"form-select",children:[e.jsx("option",{value:"All",children:"All Organizations"}),e.jsx("option",{value:"none",children:"No Organization"}),n.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsxs("select",{value:`${h.key}-${h.direction}`,onChange:a=>{const[l,r]=a.target.value.split("-");U({key:l,direction:r})},className:"form-select",children:[e.jsx("option",{value:"created_at-descending",children:"Recently Added"}),e.jsx("option",{value:"created_at-ascending",children:"Oldest First"}),e.jsx("option",{value:"name-ascending",children:"Name (A-Z)"}),e.jsx("option",{value:"name-descending",children:"Name (Z-A)"}),e.jsx("option",{value:"role-ascending",children:"Role (A-Z)"}),e.jsx("option",{value:"role-descending",children:"Role (Z-A)"}),e.jsx("option",{value:"organization-ascending",children:"Organization (A-Z)"}),e.jsx("option",{value:"organization-descending",children:"Organization (Z-A)"})]})]})}),e.jsx(R,{columns:M,data:S,renderActions:a=>e.jsxs("div",{className:"space-x-2",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>_(a),children:"Edit"}),e.jsx(x,{variant:"danger",size:"sm",onClick:()=>E(a.id),children:"Delete"})]})}),i&&e.jsx($,{isOpen:i,onClose:b,user:N,organizations:n})]})};export{q as default};
